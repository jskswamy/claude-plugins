# devenv

A devbox-like experience for managing Nix flake development environments through Claude Code.

## Features

- **Auto-detection**: Automatically detects your project's tech stack and suggests appropriate packages
- **Native Nix pre-commit**: Uses [git-hooks.nix](https://github.com/cachix/git-hooks.nix) for pure Nix pre-commit integration
- **Security tooling**: Built-in support for gitleaks and SAST tools
- **Nix best practices**: Generated flakes follow Nix conventions and are automatically linted/formatted
- **No system dependencies**: All tools run via Nix, ensuring reproducibility

## Prerequisites

- [Nix](https://nixos.org/download.html) with flakes enabled
- [direnv](https://direnv.net/) (optional, but recommended)

### Enable Nix Flakes

Add to `~/.config/nix/nix.conf`:
```
experimental-features = nix-command flakes
```

## Installation

```
/plugin install devenv@claude-plugins
```

## Usage

### Initialize a New Environment

```
/devenv
```

The command will:
1. Scan your repository for language indicators (package.json, Cargo.toml, go.mod, etc.)
2. Read CLAUDE.md for additional context
3. Suggest detected packages for confirmation
4. Ask for any additional packages
5. Offer security tools (pre-commit via git-hooks.nix, gitleaks)
6. Generate `flake.nix` and `.envrc`

### Manage Existing Environment

Run `/devenv` again to:
- **Add packages**: Add new packages to your environment
- **Upgrade packages**: Update flake.lock to get latest versions
- **Remove packages**: Remove packages from your environment
- **Setup security tools**: Add pre-commit and gitleaks (if not already configured)

## Generated Files

| File | Purpose |
|------|---------|
| `flake.nix` | Nix flake with development shell and pre-commit hooks |
| `flake.lock` | Lock file for reproducibility |
| `.envrc` | direnv integration (`use flake`) |

Note: `.pre-commit-config.yaml` is auto-generated by git-hooks.nix when you run `nix develop`.

## Auto-Detection

The plugin detects these project types:

| File | Detected Stack | Suggested Packages |
|------|---------------|-------------------|
| `package.json` | Node.js | nodejs, npm/pnpm/yarn |
| `Cargo.toml` | Rust | rustc, cargo, rust-analyzer |
| `go.mod` | Go | go, gopls |
| `pyproject.toml` | Python | python3, uv |
| `requirements.txt` | Python | python3, pip |
| `Gemfile` | Ruby | ruby, bundler |
| `pom.xml` | Java | jdk, maven |
| `build.gradle` | Java/Kotlin | jdk, gradle |

## Security Tools (git-hooks.nix)

When pre-commit is selected, the plugin uses [git-hooks.nix](https://github.com/cachix/git-hooks.nix) to configure hooks natively in Nix.

### Hooks by Language

| Language | Enabled Hooks |
|----------|---------------|
| JavaScript/TypeScript | eslint, prettier |
| Python | ruff, ruff-format |
| Go | golangci-lint |
| Rust | clippy, rustfmt |
| Nix | nixfmt-rfc-style, statix, deadnix |
| Shell | shellcheck |
| Docker | hadolint |
| Secrets | gitleaks |
| General | check-yaml, trailing-whitespace, end-of-file-fixer |

### Benefits of git-hooks.nix

- **Pure Nix**: No external `.pre-commit-config.yaml` to maintain
- **Reproducible**: All tools provided by Nix
- **CI integration**: Run `nix flake check` to validate hooks in CI
- **Auto-install**: Hooks install automatically on `nix develop`

## Automatic Flake Linting

The plugin includes hooks that automatically run on any `flake.nix` modification:

1. **nixfmt** - Formats Nix code (RFC style)
2. **statix** - Fixes anti-patterns
3. **deadnix** - Removes unused code

## Configuration

Create `.claude/devenv.local.md` to customize defaults:

```yaml
---
nixpkgs_channel: nixos-unstable
---
```

### Available Settings

| Setting | Default | Description |
|---------|---------|-------------|
| `nixpkgs_channel` | `nixos-unstable` | Nixpkgs channel to use |

## Entering the Environment

After setup, enter your development environment:

```bash
# With direnv (auto-activates on cd)
direnv allow

# Or manually
nix develop
```

When you enter the shell, pre-commit hooks are automatically installed.

## Example

```
$ /devenv

Detected packages based on your repository:
[x] nodejs_22
[x] pnpm
[x] typescript

Any additional packages? redis, postgresql

Security tools:
[x] pre-commit (git-hooks.nix)
[x] gitleaks

Creating flake.nix with git-hooks.nix integration...
Creating .envrc...
Running nix flake lock...

Done! Run 'direnv allow' or 'nix develop' to enter your environment.

Pre-commit hooks will auto-install when you enter the shell.
Run 'pre-commit run --all-files' to check all files.
Run 'nix flake check' to validate in CI.
```

## CI Integration

With git-hooks.nix, you can validate hooks in CI:

```yaml
# GitHub Actions example
- name: Check pre-commit hooks
  run: nix flake check
```

## Troubleshooting

### "nix-shell not found"

Ensure Nix is installed and in your PATH:
```bash
curl -L https://nixos.org/nix/install | sh
```

### "flakes are disabled"

Enable flakes in your Nix configuration:
```bash
echo "experimental-features = nix-command flakes" >> ~/.config/nix/nix.conf
```

### Hooks not running on flake.nix

Restart Claude Code to reload the plugin hooks.

### Pre-commit hooks not installing

Exit and re-enter the nix shell:
```bash
exit
nix develop
```

## License

MIT
